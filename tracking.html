<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Tracking - Mr Local</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .status-progress {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }
        .status-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .status-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #ddd;
            z-index: 0;
        }
        .status-step:first-child::before {
            display: none;
        }
        .status-step.active::before {
            background: #37B34A;
        }
        .status-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            position: relative;
            z-index: 1;
            font-weight: bold;
        }
        .status-step.active .status-icon {
            background: #37B34A;
        }
        .status-step.completed .status-icon {
            background: #37B34A;
        }
        .status-label {
            font-size: 0.85rem;
            color: #666;
        }
        .status-step.active .status-label,
        .status-step.completed .status-label {
            color: #37B34A;
            font-weight: 600;
        }
        .order-items {
            margin: 1rem 0;
        }
        .order-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        .order-item-info {
            flex: 1;
        }
    </style>
</head>

<body>
    <header>
        <div class="container header-content">
            <a href="index.html" class="logo">Mr Local</a>
        </div>
    </header>

    <main class="container" style="padding-top: 2rem;">
        <div style="max-width: 700px; margin: 0 auto;">
            <!-- Lookup Form -->
            <div id="lookup-form" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <h1 style="text-align: center; margin-bottom: 1.5rem;">Track Your Order</h1>
                <form onsubmit="lookupOrder(event)" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="form-group">
                        <label>Order ID</label>
                        <input type="text" id="lookup-order-id" placeholder="e.g., 123" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="text-align: center; color: #666; margin: 0.5rem 0;">OR</div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="lookup-phone" placeholder="e.g., 077 123 4567" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <button type="submit" class="checkout-btn" style="width: 100%;">Track Order</button>
                </form>
            </div>

            <!-- Order Details (Hidden initially) -->
            <div id="order-details" style="display: none; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1>Order Details</h1>
                </div>

                <div style="background: #f9f9f9; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
                    <p style="margin: 0.5rem 0;"><strong>Order ID:</strong> <span id="order-id">#---</span></p>
                    <p style="margin: 0.5rem 0;"><strong>Customer:</strong> <span id="order-customer">---</span></p>
                    <p style="margin: 0.5rem 0;"><strong>Phone:</strong> <span id="order-phone">---</span></p>
                    <p style="margin: 0.5rem 0;"><strong>Address:</strong> <span id="order-address">---</span></p>
                    <p style="margin: 0.5rem 0;"><strong>Total:</strong> <span id="order-total">AED 0.00</span></p>
                    <p style="margin: 0.5rem 0;"><strong>Date:</strong> <span id="order-date">---</span></p>
                </div>

                <!-- Status Progress -->
                <div class="status-progress" id="status-progress">
                    <!-- Will be populated by JS -->
                </div>

                <!-- Order Items -->
                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Order Items</h3>
                    <div id="order-items" class="order-items">
                        <!-- Will be populated by JS -->
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <a href="index.html" class="add-btn" style="text-decoration: none; display: inline-block;">Continue Shopping</a>
                    <button onclick="showLookupForm()" class="add-btn" style="margin-left: 1rem; background: #666;">Track Another Order</button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" style="display: none; background: #fee; color: #c33; padding: 1rem; border-radius: 4px; text-align: center; margin-top: 1rem;"></div>
        </div>
    </main>

    <script>
        const MOCK_MODE = true; // Set to false when using PHP backend

        // Check if order ID is in URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderIdFromUrl = urlParams.get('id');
        if (orderIdFromUrl) {
            document.getElementById('lookup-order-id').value = orderIdFromUrl;
            lookupOrder(new Event('submit'), orderIdFromUrl);
        }

        async function lookupOrder(event, orderId = null) {
            if (event) event.preventDefault();

            const orderIdInput = document.getElementById('lookup-order-id').value.trim();
            const phoneInput = document.getElementById('lookup-phone').value.trim();
            const errorDiv = document.getElementById('error-message');
            const lookupForm = document.getElementById('lookup-form');
            const orderDetails = document.getElementById('order-details');

            errorDiv.style.display = 'none';

            if (!orderId && !orderIdInput && !phoneInput) {
                errorDiv.textContent = 'Please enter an Order ID or Phone Number';
                errorDiv.style.display = 'block';
                return;
            }

            const idToUse = orderId || orderIdInput;
            let order = null;

            if (MOCK_MODE) {
                // Mock order for testing
                order = {
                    id: idToUse || '123',
                    customer_name: 'John Doe',
                    phone: phoneInput || '0771234567',
                    address: 'Downtown, Building 5, Apt 301',
                    total_amount: '125.50',
                    status: 'confirmed',
                    created_at: '2024-01-15 10:30:00',
                    items: [
                        { name: 'Fresh Tomatoes (1kg)', quantity: 2, price: '5.50', image_url: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=400&q=80' },
                        { name: 'Fresh Milk (2L)', quantity: 1, price: '12.00', image_url: 'https://images.unsplash.com/photo-1563636619-e9143da7973b?auto=format&fit=crop&w=400&q=80' }
                    ]
                };
            } else {
                try {
                    let url = 'api/get_order.php?';
                    if (idToUse) {
                        url += 'id=' + encodeURIComponent(idToUse);
                    } else {
                        url += 'phone=' + encodeURIComponent(phoneInput);
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success) {
                        order = data.order;
                    } else {
                        errorDiv.textContent = data.message || 'Order not found';
                        errorDiv.style.display = 'block';
                        return;
                    }
                } catch (error) {
                    errorDiv.textContent = 'Error fetching order. Please try again.';
                    errorDiv.style.display = 'block';
                    console.error(error);
                    return;
                }
            }

            // Display order details
            displayOrderDetails(order);
            lookupForm.style.display = 'none';
            orderDetails.style.display = 'block';
        }

        function displayOrderDetails(order) {
            document.getElementById('order-id').textContent = '#' + order.id;
            document.getElementById('order-customer').textContent = order.customer_name;
            document.getElementById('order-phone').textContent = order.phone;
            document.getElementById('order-address').textContent = order.address;
            document.getElementById('order-total').textContent = 'AED ' + parseFloat(order.total_amount).toFixed(2);
            
            const date = new Date(order.created_at);
            document.getElementById('order-date').textContent = date.toLocaleString();

            // Display status progress
            const statuses = ['pending', 'confirmed', 'shipping', 'delivered'];
            const currentStatus = order.status;
            const currentIndex = statuses.indexOf(currentStatus);

            const progressHtml = statuses.map((status, index) => {
                let className = '';
                if (index < currentIndex) {
                    className = 'completed';
                } else if (index === currentIndex) {
                    className = 'active';
                }

                const labels = {
                    'pending': 'Pending',
                    'confirmed': 'Confirmed',
                    'shipping': 'Shipping',
                    'delivered': 'Delivered'
                };

                return `
                    <div class="status-step ${className}">
                        <div class="status-icon">${index + 1}</div>
                        <div class="status-label">${labels[status]}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('status-progress').innerHTML = progressHtml;

            // Display order items
            const itemsHtml = order.items.map(item => `
                <div class="order-item">
                    <img src="${item.image_url || 'https://via.placeholder.com/60'}" alt="${item.name}">
                    <div class="order-item-info">
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="color: #666; font-size: 0.9rem;">Quantity: ${item.quantity}</div>
                        <div style="font-weight: 600; color: #383838;">AED ${parseFloat(item.price).toFixed(2)}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('order-items').innerHTML = itemsHtml;
        }

        function showLookupForm() {
            document.getElementById('lookup-form').style.display = 'block';
            document.getElementById('order-details').style.display = 'none';
            document.getElementById('lookup-order-id').value = '';
            document.getElementById('lookup-phone').value = '';
        }
    </script>
</body>

</html>